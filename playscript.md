# 全文検索エンジンgroongaを囲む夕べ 3 原稿 「rroongaを使ったソースコード検索エンジン Milkode」

疲れているのでデモ中心に。
最初に知っている人、使っている人を挙手してもらう。

## 準備:

```bash
# Term2で実行
milk setdb ~/tmp/milkode_tokyu05
milk web

# Term2 2枚目
cd ~/tmp/milkode_rroonga
milk web -p 9293
```

- 両方ともホームページを開いておく
- Emacsの *blank.rb* は閉じておく
- スライドのサイズ調整

## ページ1: タイトルロゴ

## ページ2: rroongaを使ったソースコード検索エンジン Milkode
こんにちは、ongaeshiと申します。

今日は私の作成しておりますMilkodeというソースコード検索エンジンで、
rroongaをどのように利用しているかについて発表させて頂きます。

## ページ3: 自己紹介
最初に自己紹介をさせて下さい。

## ページ4: 自己紹介
ongaeshiといいます。プログラマを生業にしており趣味でソフトウェアを作って公開してます

## ページ5,6: 今日の予定
アジェンダです。

最初にMilkodeの簡単な紹介をしてから、
rroongaをストレージエンジンとして使った理由についてお話しします。
最後に具体的な使い方についてご紹介出来ればと思います。

## ページ7: Milkodeについて
それではMilkodeの紹介をします。

## ページ8: 何なの？
Milkodeはソースコード検索に特化した検索エンジンです。
ローカルやWeb上にあるソースコードを登録して高速に検索することが出来ます。

## ページ9: 特徴は？
特徴です。

```tokuchou.txt
●[ENTER] 高速
まずは高速性です。 20000ファイル位であれば1秒以内に検索することが出来ます。

●[ENTER] 行指向
次に行指向の検索エンジンであることです。一般的に検索エンジンは「特定の単語を含むファイル」を見つけますが、Milkodeは「特定の単語を含む行」を見つけます。 

●[ENTER] エディタでもブラウザでも
webアプリとコマンドラインツールを状況に応じて使い分けることが出来ます。

●[ENTER] もっとコードリーディングを簡単に
このようにコードリーディングを簡単に行うことが出来ます。
```

## ページ10: ソフトウェアの構成
ソフトウェアの構成です。
rroongaをはじめとしてたくさんのgemを使っています。

## ページ11: デモ
それでは実際に動いている所をご紹介したいと思います。

```demo.txt
● Firefoxに切り替え、:9292を開く
milk web コマンドでアプリを起動するとこのような画面が表示されます。

現在はruby, mruby, node.js, rails 等のソースコードが登録されており、全部で13207ファイルあります。
試しに Rails#ActiveSupport の有名なメソッド blank? を探してみましょう。

まずはrailsパッケージに移動します。
● railsパッケージに移動

'blank'で検索してみます。
● blank [ENTER]

たくさんの結果が出て来ました。ドキュメント等にもマッチしているので絞り込みを行いたいと思います。
's:オプション'を付けて拡張子による絞り込みを行います。
● def blank s:rb [ENTER]

続いて activesupport/ フォルダ以下に検索対象を絞り込んでいきます。
'f:オプション'を付けてファイル名による絞り込みを行います。
● def blank s:rb f:activesupport [ENTER]

関数定義以外の部分にもマッチしていますね。
キーワード'def'を追加してAND検索しましょう。
● def blank [ENTER]

それらしき物が出てきました。
● クリック
おそらく blank? メソッドの実装らしきものを見つける事が出来ました。

次に見つけたblank?メソッドの定義をエディタで開いてみましょう。
● 14行目をクリック

一番上に表示されるのはダイレクトパスといってMilkodeで特殊な意味を持つものです。
コピーしておきます。
● ダイレクトパスをコピー

Emacsを開きます。milkode.el という EmacsLisp が用意されているのでそれを使うと・・
● M-g ダイレクトパスを貼付け

ファイルの実体をエディタで開くことが出来ました。
● エディタとブラウザを行ったり来たり
```

milkode.el は gmilkというgrep互換のコマンドラインツールを利用して実現しており、
似たようなことは他のエディタでも実現出来るのではないかと思っています。

もう一つデモを紹介します。

```demo2.txt
● :9293 に移動

これは、今私が使っているノートパソコンの全データをデータベースに登録したものです。
全部で178496ファイル、データベースの容量は 5.36GB 程になりました。
これを使えばマシン内の全てのテキストから任意の行を引っ張り出すことが可能です。

では試しに'焼きそば'で検索してみましょう。
● 焼きそば [ENTER]

アプリが内部で使っている辞書データや、自分が昔'あんかけ焼きそば'というタイトルのブログを書いていた事、
冷蔵庫の残り物を使ってあんかけ焼きそばを使っていたことが分かりました。
```

Milkodeを使うと、このように簡単に任意の一行を見つけることが出来ます。

## ページ12: 何でrroonga?
それでは次にrroongaをストレージエンジンとして使った理由についてです。

## ページ13: groongaがカラムストア機能付きだから！
まず、groongaがカラムストア機能付きである、ということが挙げられます。
MySQL等のインストールが必須ではなく、
'gem install rroonga'でgroongaもまとめてインストールしてくれるため・・

```groonga_merit.txt
● [ENTER] 配布が簡単
配布を簡単に行うことが出来ました。

他の検索エンジンが別途ストレージのインストールを必要とするものが多いことを考えると、
gem install milkode で必要なものが全て揃うのは大きなメリットだと思っています。

● [ENTER] このような特性を持つため・・
またこのような特性を持つため、

● [ENTER] ローカルアプリと相性がよい
rroongaはローカルアプリとの相性もとてもよいと感じています。
```

## ページ14: Rubyだけで書ける、サポートも充実
さらに、Rubyだけでデータベースをフルコントロール出来ることや、
日本語の情報が豊富で開発が活発に行われていることもよかった所です。

## ページ15: rroongaの使い方
最後に具体的なrroongaの使い方についてご紹介します。

## ページ16: 基本的な使い方
Milkodeでは主に二つのGroongaテーブルを使っています。

一つが主の検索対象となるソースコードのテーブル(documents)と、
Milkodeの追加単位であるパッケージ情報を管理するテーブル(packages)です。

これらのテーブルに対する追加や削除、
入力に対する検索結果を様々なフォーマットで出力するのがMilkodeの主な仕事となります。

## ページ17: ソースコードのテーブル(documents)
ソースコードテーブルのスキーマです。

1ファイルを1レコードとして登録しています。
拡張子を専用カラムとしてあらかじめ持っていたりします。

## ページ18: パッケージのテーブル(packages)
パッケージテーブルのスキーマです。

ホーム画面やパッケージ一覧を作るのに使っています。

## ページ19: どうよって行を絞り込むの？
次に、Milkodeの特徴の一つである行の絞り込み方法の紹介です。

まず普通にrroongaを使いキーワードを持っている可能性のあるレコードを絞り込みます。
次に絞り込んだレコードを一行ずつRubyで検索することで、
目的の一行を見つけ出すことが出来ます。

とてもシンプルな仕組みで実現しています。

## ページ20: トークナイザーの設定
ちょっと変わったこととして、全文検索時のトークナイザーは TokenBigramSplitSymbolAlphaDigit を使っています。

これは'robo123'というキーワードがあった時に'robo'でも'123'でもマッチするようにするためのもので、ソースコード検索ではその方が都合がいいからです。

## ページ21: ありがとうございました
Milkodeはまだまだ発展途中のソフトウェアのため、皆さんに使って頂きフィードバックがもらえればと思っています。
何か気になることがありましたらTwitterやメール、この後の懇親会等で教えて頂ければ幸いです。

どうもありがとうございました。

